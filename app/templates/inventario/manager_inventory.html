{% extends "base.html" %}

{% block content %}
<section id="features" class="ud-features">
    


   
   <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
       {% if messages %}
       <div class="alert alert-dismissible fade show" role="alert">
         {% for category, message in messages %}
            <div class="alert alert-{{ category }} mb-3">{{ message }}</div>
         {% endfor %}
      </div>
      {% endif %}
    {% endwith %}
    <h1>Inventario - {{ business_name }}</h1>
    

    <div class="container mt-4">
        <div class="row">
            <!-- Tabla de Categorías -->
            <div class="col-md-8">
                <h2>Categorías</h2>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Productos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in categories %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ category.name }}</td>
                            <td>{{ category.description or "Sin descripción" }}</td>
                            <td>{{ category.products.count() }}</td> <!-- Muestra la cantidad de productos -->
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Botones y Acciones -->
            <div class="col-md-4">
                <div class="d-flex flex-column align-items-start">
                    <h2>Opciones :</h2>
                    <!-- Botón para crear una categoría -->
                    <button class="btn btn-primary mb-3 fixed-width-btn" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        Crear Categoría
                    </button>

                    <!-- Botón para crear un producto -->
                    <button class="btn btn-success mb-3 fixed-width-btn" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        Crear Producto
                    </button>

                    <!-- Botón para imprimir selección -->
                    <button class="btn btn-warning mb-3 fixed-width-btn" id="printSelectionButton">
                        Imprimir Selección
                    </button>

                    <!-- Botón para regresar al Panel TCP -->
                    <a href="{{ url_for('tcp.panel_tcp') }}" class="btn btn-secondary mt-3 fixed-width-btn">
                        Regresar al Panel TCP
                    </a>
                </div>
            </div>
        </div>

        <!-- Tabla de Productos -->
        <div class="row mt-4">
            <div class="col">
                <h2>Productos</h2>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Tipo</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ product.name }}</td>
                            <td>{{ product.category.name }}</td>
                            <td>{{ product.tipo }}</td>
                            <td>${{ product.price }}</td>
                            <td>
                                {% if product.cost_sheet and product.cost_sheet.updated_at %}
                                    {{ product.cost_sheet.updated_at.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}
                                    No editada
                                {% endif %}
                            </td>
                            <td>
                                {% if product.cost_sheet %}                       
                                    <!-- Botón para editar ficha de costo -->
                                    <a href="{{ url_for('ficha-costo.manage_cost_sheet', product_id=product.id) }}" class="btn btn-info btn-sm">
                                           Editar Ficha de Costo
                                    </a>
                                {% else %}
                                    <!-- Botón para crear ficha de costo -->
                                    <a href="{{ url_for('ficha-costo.manage_cost_sheet', product_id=product.id) }}" class="btn btn-primary btn-sm">
                                            Crear Ficha de Costo
                                    </a>
                                {% endif %}
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.id }}">
                                    Editar Producto
                                </button>
                                <form method="POST" action="{{ url_for('inventario.delete_product', product_id=product.id) }}" onsubmit="return confirm('¿Estás seguro de eliminar este producto?');" class="d-inline">
                                    <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- Modal Agregar Categoría -->
   <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('inventario.add_category') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryLabel">Agregar Categoría</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category-name" class="form-label">Nombre de la Categoría</label>
                        <input type="text" class="form-control" id="category-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category-desc" class="form-label">Descripcion de la Categoría</label>
                        <input type="text" class="form-control" id="category-desc" name="desc" required>
                    </div>
                    <input type="hidden" name="business_id" value="{{ business_id }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
   </div>

<!-- Modal Agregar Producto -->
   <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('inventario.add_product') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductLabel">Agregar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="product-name" class="form-label">Nombre del Producto</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category-id" class="form-label">Categoría</label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="category-id" class="form-label">Tipo</label>
                        <select class="form-select" id="type" name="type" required>
                                <option >Servicio</option>
                                <option >Fisico</option>
                                <option >Digital</option>
                            
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="stock" name="stock" required>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Precio</label>
                        <input type="number" class="form-control" id="price" name="price" required>
                    </div>
                    <input type="hidden" name="business_id" value="{{ business_id }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
   </div>


<script>

document.addEventListener('DOMContentLoaded', () => {
    const conceptsTableBody = document.querySelector('#conceptsTable tbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const saveConceptsBtn = document.getElementById('saveConceptsBtn');
    const costSheetId = document.getElementById('costSheetModal').getAttribute('data-cost-sheet-id');

    // Cargar conceptos existentes
    function loadConcepts() {
        fetch(`/fetch_concepts/${costSheetId}`)
            .then(response => response.json())
            .then(data => {
                conceptsTableBody.innerHTML = '';
                if (data.status === 'success' && data.concepts.length > 0) {
                    data.concepts.forEach(concept => {
                        addConceptRow(concept);
                    });
                } else {
                    addEmptyRow();
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Agregar una fila vacía
    function addEmptyRow() {
        const row = `
            <tr>
                <td><input type="text" class="form-control" name="concept"></td>
                <td><input type="number" class="form-control" name="row"></td>
                <td><input type="number" class="form-control" name="base_cost" step="0.01"></td>
                <td><input type="number" class="form-control" name="new_cost" step="0.01"></td>
                <td>
                    <button class="btn btn-danger btn-sm deleteRowBtn">Eliminar</button>
                </td>
            </tr>`;
        conceptsTableBody.insertAdjacentHTML('beforeend', row);
    }

    // Agregar una fila con datos
    function addConceptRow(concept) {
        const row = `
            <tr data-id="${concept.id}">
                <td><input type="text" class="form-control" name="concept" value="${concept.concept}"></td>
                <td><input type="number" class="form-control" name="row" value="${concept.row}"></td>
                <td><input type="number" class="form-control" name="base_cost" value="${concept.base_cost}" step="0.01"></td>
                <td><input type="number" class="form-control" name="new_cost" value="${concept.new_cost}" step="0.01"></td>
                <td>
                    <button class="btn btn-danger btn-sm deleteRowBtn">Eliminar</button>
                </td>
            </tr>`;
        conceptsTableBody.insertAdjacentHTML('beforeend', row);
    }

    // Eliminar fila
    conceptsTableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('deleteRowBtn')) {
            event.target.closest('tr').remove();
        }
    });

    // Guardar conceptos
    saveConceptsBtn.addEventListener('click', () => {
        const rows = conceptsTableBody.querySelectorAll('tr');
        const concepts = Array.from(rows).map(row => ({
            id: row.dataset.id || null,
            concept: row.querySelector('[name="concept"]').value,
            row: row.querySelector('[name="row"]').value,
            base_cost: row.querySelector('[name="base_cost"]').value,
            new_cost: row.querySelector('[name="new_cost"]').value,
        }));

        fetch('/save_concepts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cost_sheet_id: costSheetId, concepts })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Conceptos guardados con éxito');
                    loadConcepts();
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => console.error('Error:', error));
    });

    // Cargar conceptos al abrir el modal
    loadConcepts();
});

</script>
</section>
{% endblock %}
