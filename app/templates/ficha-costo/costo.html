{% extends 'base.html' %}
{% block titulo %} FICHA DE COSTO {% endblock %}
{% block content %}
<!-- Incluir Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Incluir Font Awesome para íconos -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<section id="features" class="ud-features">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert alert-dismissible fade show" role="alert">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mb-3">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <div class="container mt-4">
        <h1 class="mb-4">{{ 'Editar' if cost_sheet else 'Crear' }} Ficha de Costo para {{ product.name }}</h1>

        <!-- Formulario principal -->
        <form method="POST" action="{{ url_for('ficha-costo.create_cost_sheet', product_id=product.id) }}" class="mb-4">
            <div class="mb-3">
                <label for="production_level" class="form-label">Nivel de Producción:</label>
                <input type="number" name="production_level" value="{{ cost_sheet.production_level if cost_sheet else '' }}" class="form-control" required>
            </div>

            <div class="mb-3">
                <label for="utilization_percentage" class="form-label">Porcentaje de Utilización:</label>
                <input type="number" step="0.01" name="utilization_percentage" value="{{ cost_sheet.utilization_percentage if cost_sheet else '' }}" class="form-control" required>
            </div>

            <div class="mb-3">
                <label for="precio_de_costo" class="form-label">Precio de Costo:</label>
                <input type="number" step="0.01" name="precio_de_costo" value="{{ cost_sheet.precio_de_costo if cost_sheet else '' }}" class="form-control" required>
            </div>

            <h2 class="mb-3">Conceptos de Costo</h2>
            <div id="concepts">
                {% if concepts %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Seleccionar</th>
                                <th>Fila</th>
                                <th>Nombre</th>
                                <th>Costo Base</th>
                                <th>Nuevo Costo</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for concept in concepts %}
                                <tr>
                                    <td><input type="checkbox" name="delete_concept[]" value="{{ concept.id }}"></td>
                                    <td>{{ concept.row }}</td> <!-- Mostrar fila como texto -->
                                    <td>{{ concept.concept }}</td>
                                    <td>{{ concept.base_cost }}</td>
                                    <td>{{ concept.new_cost }}</td>
                                    <td>
                                        <!-- Mostrar etiqueta de tipo con color -->
                                        {% if concept.concept_type == 'material' %}
                                            <span class="badge bg-success"><i class="fas fa-dollar-sign"></i> Gastos materiales</span>
                                        {% elif concept.concept_type == 'salary' %}
                                            <span class="badge bg-primary"><i class="fas fa-chart-line"></i> Salario directo</span>
                                        {% elif concept.concept_type == 'direct' %}
                                            <span class="badge bg-warning text-dark"><i class="fas fa-box"></i> Gastos directos</span>
                                        {% elif concept.concept_type == 'production' %}
                                            <span class="badge bg-info text-dark"><i class="fas fa-industry"></i> Gastos asociados a la producción</span>
                                        {% elif concept.concept_type == 'sum_1_4' %}
                                            <span class="badge bg-secondary"><i class="fas fa-plus"></i> Suma de filas 1 a 4</span>
                                        {% elif concept.concept_type == 'admin' %}
                                            <span class="badge bg-danger"><i class="fas fa-building"></i> Gastos generales de administración</span>
                                        {% elif concept.concept_type == 'sales' %}
                                            <span class="badge bg-dark"><i class="fas fa-truck"></i> Gastos de distribución de ventas</span>
                                        {% elif concept.concept_type == 'financial' %}
                                            <span class="badge bg-light text-dark"><i class="fas fa-money-bill"></i> Gastos financieros</span>
                                        {% elif concept.concept_type == 'osde' %}
                                            <span class="badge bg-purple"><i class="fas fa-hand-holding-usd"></i> Gastos por financiamiento de la OSDE</span>
                                        {% elif concept.concept_type == 'taxes' %}
                                            <span class="badge bg-orange"><i class="fas fa-percentage"></i> Gastos por conceptos de impuestos</span>
                                        {% elif concept.concept_type == 'sum_6_10' %}
                                            <span class="badge bg-gray"><i class="fas fa-plus"></i> Suma de filas 6 a 10</span>
                                        {% elif concept.concept_type == 'sum_1_10' %}
                                            <span class="badge bg-teal"><i class="fas fa-plus"></i> Suma de filas 1 a 10</span>
                                        {% elif concept.concept_type == 'utility' %}
                                            <span class="badge bg-pink"><i class="fas fa-chart-bar"></i> Utilidad</span>
                                        {% elif concept.concept_type == 'price' %}
                                            <span class="badge bg-brown"><i class="fas fa-tag"></i> Precio o tarifa</span>
                                        {% elif concept.concept_type == 'adjusted_price' %}
                                            <span class="badge bg-yellow"><i class="fas fa-tags"></i> Precio o tarifa ajustada</span>
                                        {% elif concept.concept_type == 'reference_price' %}
                                            <span class="badge bg-green"><i class="fas fa-dollar-sign"></i> Precio de referencia</span>
                                        {% elif concept.concept_type == 'other' %}
                                            <span class="badge bg-black"><i class="fas fa-question-circle"></i> Otros gastos</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-warning" onclick="editConcept(
                                            '{{ concept.id }}',
                                            '{{ concept.concept }}',
                                            '{{ concept.base_cost }}',
                                            '{{ concept.new_cost }}',
                                            '{{ concept.concept_type }}'
                                        )">Editar</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No hay conceptos registrados.</p>
                {% endif %}
            </div>

            <!-- Botones -->
            <button type="button" class="btn btn-primary" onclick="openModal()">Agregar Concepto</button>
            <button type="submit" name="action" value="save" class="btn btn-success">Guardar Cambios</button>
            <button type="submit" name="action" value="delete" class="btn btn-danger">Eliminar Seleccionados</button>
            <a href="{{ url_for('inventario.index') }}" class="btn btn-secondary">Volver a Productos</a>
        </form>

        <!-- Ventana modal para agregar/editar un concepto -->
        <div class="modal fade" id="conceptModal" tabindex="-1" aria-labelledby="conceptModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="conceptModalLabel">Agregar Concepto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="{{ url_for('ficha-costo.create_cost_sheet', product_id=product.id) }}">
                            <input type="hidden" id="concept-id" name="concept_id" value="">
                            <input type="hidden" name="action" value="add_concept">

                            <!-- No incluimos un campo para "Fila" porque es generado automáticamente -->

                            <div class="mb-3">
                                <label for="concept-name" class="form-label">Nombre del Concepto:</label>
                                <input type="text" id="concept-name" name="concept" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="concept-base-cost" class="form-label">Costo Base:</label>
                                <input type="number" step="0.01" id="concept-base-cost" name="base_cost" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="concept-new-cost" class="form-label">Nuevo Costo:</label>
                                <input type="number" step="0.01" id="concept-new-cost" name="new_cost" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="concept-type" class="form-label">Tipo de Concepto:</label>
                                <select id="concept-type" name="concept_type" class="form-select" required>
                                    {% for type, label in concept_types %}
                                        <option value="{{ type }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Incluir Bootstrap JS y Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Función para abrir la ventana modal en modo "Agregar"
    function openModal() {
        document.getElementById('conceptModalLabel').innerText = 'Agregar Concepto';
        document.getElementById('concept-id').value = '';
        document.getElementById('concept-name').value = '';
        document.getElementById('concept-base-cost').value = '';
        document.getElementById('concept-new-cost').value = '';
        document.getElementById('concept-type').value = '';
        var modal = new bootstrap.Modal(document.getElementById('conceptModal'));
        modal.show();
    }

    // Función para abrir la ventana modal en modo "Editar"
    function editConcept(id, name, baseCost, newCost, type) {
        document.getElementById('conceptModalLabel').innerText = 'Editar Concepto';
        document.getElementById('concept-id').value = id;
        document.getElementById('concept-name').value = name;
        document.getElementById('concept-base-cost').value = baseCost;
        document.getElementById('concept-new-cost').value = newCost;
        document.getElementById('concept-type').value = type;
        var modal = new bootstrap.Modal(document.getElementById('conceptModal'));
        modal.show();
    }
</script>
{% endblock %}